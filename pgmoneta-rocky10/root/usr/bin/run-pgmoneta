#!/bin/bash
# /usr/bin/run-pgmoneta

NODE_EXPORTER_PIDFILE=/tmp/node_exporter.pid

# Trap signals for graceful shutdown
function trap_sigterm() {
    echo "Received SIGTERM, shutting down..."
    if [ -f $NODE_EXPORTER_PIDFILE ]; then
        kill -SIGINT $(head -1 $NODE_EXPORTER_PIDFILE) 2>/dev/null
    fi
}

trap 'trap_sigterm' SIGINT SIGTERM

# Socket directory
mkdir -p /var/run/pgmoneta

if [ ! -f /pgmoneta/pgmoneta.conf ]; then
    echo "First run: Setting up pgmoneta..."
    
    required_vars=("PG_PRIMARY_NAME" "PG_PRIMARY_PORT" "PG_BACKUP_NAME" "PG_BACKUP_PASSWORD" "PG_BACKUP_SLOT")
    for var in "${required_vars[@]}"; do
        if [ -z "${!var}" ]; then
            echo "ERROR: $var is not set!"
            exit 1
        fi
    done
    
    cp /conf/pgmoneta.conf /tmp/pgmoneta.conf.tmp
    
    sed -i "s/PG_PRIMARY_NAME/$PG_PRIMARY_NAME/g" /tmp/pgmoneta.conf.tmp
    sed -i "s/PG_PRIMARY_PORT/$PG_PRIMARY_PORT/g" /tmp/pgmoneta.conf.tmp
    sed -i "s/PG_BACKUP_NAME/$PG_BACKUP_NAME/g" /tmp/pgmoneta.conf.tmp
    sed -i "s/PG_BACKUP_SLOT/$PG_BACKUP_SLOT/g" /tmp/pgmoneta.conf.tmp
    
    if [ -f /pgconf/root.crt ] && [ -f /pgconf/server.crt ] && [ -f /pgconf/server.key ]; then
        echo "Enabling TLS..."
        sed -i "s/#tls = off/tls = on/g" /tmp/pgmoneta.conf.tmp
        
        cp /pgconf/root.crt /pgmoneta/
        cp /pgconf/server.crt /pgmoneta/
        cp /pgconf/server.key /pgmoneta/
        chmod 0600 /pgmoneta/server.key
    else
        echo "No TLS certificates found, running without TLS..."
        sed -i "s/#tls = off/tls = off/g" /tmp/pgmoneta.conf.tmp
    fi
    
    mv /tmp/pgmoneta.conf.tmp /pgmoneta/pgmoneta.conf

    echo "Initializing pgmoneta admin..."
    cd /pgmoneta

    pgmoneta-admin -g master-key
    pgmoneta-admin -f /pgmoneta/pgmoneta_users.conf -U ${PG_BACKUP_NAME} -P ${PG_BACKUP_PASSWORD} user add
    
    echo "PATH=/usr/pgsql-18/bin:\$PATH" > /home/pgmoneta/.bashrc
    echo "export PATH" >> /home/pgmoneta/.bashrc

    echo "Setting up backup schedule..."
    (echo "00 06  *   *   0     /usr/bin/pgmoneta-cli -c /pgmoneta/pgmoneta.conf backup primary") | crontab -
    
    echo "pgmoneta setup complete!"
else
    echo "Configuration already exists, using existing setup..."
fi

# Ensure backup directories exist
mkdir -p /pgmoneta/backup
mkdir -p /pgmoneta/wal

echo "Starting Node Exporter..."
/usr/local/bin/node_exporter >> /tmp/node_exporter.log 2>&1 &
echo $! > $NODE_EXPORTER_PIDFILE

echo "Starting pgmoneta..."
exec pgmoneta -c /pgmoneta/pgmoneta.conf -u /pgmoneta/pgmoneta_users.conf "$@"