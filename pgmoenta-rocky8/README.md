# pgmoneta-rocky10

Docker image for pgmoneta built on Rocky Linux 8.

## How It Works

1. Multi-stage build: pgmoneta is compiled from source in the builder stage
2. Only runtime dependencies are copied to the final image
3. `entrypoint.sh` generates config on first run using environment variables
4. On subsequent starts, it reuses the existing config

## Directory Structure Inside the Container

```
/etc/pgmoneta/                      ← config files (pgmoneta.conf, users.conf)
/home/pgmoneta/backups/             ← base_dir, where backups are stored
/home/pgmoneta/logs/                ← log files
/home/pgmoneta/.pgmoneta/           ← master key stored here by pgmoneta-admin
/tmp/                               ← unix socket
```

## Required Environment Variables

| Variable             | Required | Description                          |
|----------------------|----------|--------------------------------------|
| DB_HOST              | Yes      | PostgreSQL host                      |
| DB_PORT              | Yes      | PostgreSQL port                      |
| PGMONETA_MASTER_KEY  | Yes      | Master encryption key                |
| REPL_PASSWORD        | Yes      | Password for replication user        |

## Build and Load into Kind

```bash
make rebuild
```

## For Kubernetes (pgopr)

The Rust deployment code mounts a PVC to `/home/pgmoneta` so that
backups and logs persist across pod restarts.

Config at `/etc/pgmoneta/` is generated by entrypoint.sh on first run.